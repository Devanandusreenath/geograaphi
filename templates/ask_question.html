<!-- templates/ask_question.html -->
{% extends "base.html" %}

{% block title %}Ask AI Assistant - GeoSmart Learn{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="text-white mb-4">
            <i class="fas fa-robot"></i> AI Assistant
        </h2>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> Ask Any Geography Question</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>How it works:</strong> Ask any geography question and our AI will search through all available lesson materials to provide you with accurate answers!
                </div>
                
                <div id="chat-container" class="chat-container mb-4" style="min-height: 400px; max-height: 500px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 8px; background-color: #f8f9fa;">
                    <div class="text-center text-muted">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <p>Welcome! I'm your Geography AI Assistant.</p>
                        <p>Ask me anything about geography, and I'll help you learn!</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" class="form-control" id="question-input" 
                           placeholder="Ask your geography question here..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary" type="button" onclick="askGeneralQuestion()">
                        <i class="fas fa-paper-plane"></i> Ask
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb"></i> 
                        Example questions: "What causes earthquakes?", "Explain climate zones", "What is continental drift?"
                    </small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-history"></i> Recent Questions</h6>
            </div>
            <div class="card-body">
                <div id="recent-questions">
                    <div class="text-center py-3">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading your recent questions...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h6><i class="fas fa-tips"></i> Quick Tips</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li><i class="fas fa-check text-success"></i> Be specific in your questions</li>
                    <li><i class="fas fa-check text-success"></i> Ask about concepts from your lessons</li>
                    <li><i class="fas fa-check text-success"></i> Try different phrasings if needed</li>
                    <li><i class="fas fa-check text-success"></i> Ask follow-up questions for clarity</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function askGeneralQuestion() {
    const input = document.getElementById('question-input');
    const question = input.value.trim();
    
    if (!question) return;
    
    const chatContainer = document.getElementById('chat-container');
    
    // Add question to chat
    chatContainer.innerHTML += `
        <div class="text-end mb-3">
            <div class="d-inline-block bg-primary text-white p-2 rounded" style="max-width: 70%;">
                <strong>You:</strong> ${question}
            </div>
        </div>
    `;
    
    input.value = '';
    input.disabled = true;
    
    // Add loading indicator
    chatContainer.innerHTML += `
        <div class="mb-3">
            <div class="d-inline-block bg-light p-2 rounded" style="max-width: 70%;">
                <i class="fas fa-robot text-primary"></i> <strong>AI:</strong> 
                <i class="fas fa-spinner fa-spin"></i> Thinking...
            </div>
        </div>
    `;
    
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    fetch('/ask_question', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question: question,
            lesson_id: null  // General question, not lesson-specific
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading indicator
        const loadingDiv = chatContainer.querySelector('.bg-light:last-child').parentNode;
        loadingDiv.remove();
        
        // Add answer
        chatContainer.innerHTML += `
            <div class="mb-3">
                <div class="d-inline-block bg-light p-2 rounded" style="max-width: 80%;">
                    <i class="fas fa-robot text-primary"></i> <strong>AI:</strong> ${data.answer}
                </div>
            </div>
        `;
        
        input.disabled = false;
        input.focus();
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        // Refresh recent questions
        loadRecentQuestions();
    })
    .catch(error => {
        console.error('Error:', error);
        // Remove loading indicator
        const loadingDiv = chatContainer.querySelector('.bg-light:last-child').parentNode;
        if (loadingDiv) loadingDiv.remove();
        
        chatContainer.innerHTML += `
            <div class="mb-3">
                <div class="d-inline-block bg-danger text-white p-2 rounded" style="max-width: 70%;">
                    <i class="fas fa-exclamation-triangle"></i> Sorry, there was an error processing your question. Please try again.
                </div>
            </div>
        `;
        
        input.disabled = false;
        input.focus();
    });
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        askGeneralQuestion();
    }
}

function loadRecentQuestions() {
    fetch('/api/recent_questions')
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('recent-questions');
        if (data.questions && data.questions.length > 0) {
            container.innerHTML = data.questions.map(q => `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <small><strong>Q:</strong> ${q.question.substring(0, 50)}${q.question.length > 50 ? '...' : ''}</small><br>
                        <small class="text-muted">${q.created_at}</small>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-muted text-center">No questions asked yet.</p>';
        }
    })
    .catch(error => {
        document.getElementById('recent-questions').innerHTML = 
            '<p class="text-muted text-center">Unable to load recent questions.</p>';
    });
}

// Load recent questions on page load
document.addEventListener('DOMContentLoaded', loadRecentQuestions);
</script>

<style>
.chat-container {
    background-image: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(120, 119, 198, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.05) 0%, transparent 50%);
}

.question-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 70%;
    display: inline-block;
    word-wrap: break-word;
}

.answer-bubble {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    padding: 10px 15px;
    border-radius: 18px;
    max-width: 80%;
    display: inline-block;
    word-wrap: break-word;
}
</style>
{% endblock %}